@page "/CommandCenter"
@inject IPlayerService _playerService
@inject IThrowService _throwService
@inject IPlayerThrowService _playerThrowService
@inject NavigationManager navigation

<input type="button" class="btn btn-primary me-2 mb-3" @onclick="RedirectToAddPlayer" value="+Add Player" />
<input type="button" class="btn btn-primary mb-3" @onclick="CreateCurrentMatch" value="New Match" />

<Error ErrorMessage="@error"></Error>
<LoadingScreen IsBusy="@isBussy"></LoadingScreen>
@if (allPosibleThrow != null)
{

    <div>
        <div class="d-flex justify-content-between flex-wrap">
            @foreach (var item in allPosibleThrow)
            {
                <DartSegment DataModel="item"
                             OnSelected="AddScore"></DartSegment>
            }
        </div>
        <div class="d-flex justify-content-center mt-5" id="bull-container">
            <div id="outer-bull" class="d-flex justify-content-center align-items-center" @onclick="e => AddScore(posibleBullThrows[0])">
                <div id="inner-bull" @onclick="e => AddScore(posibleBullThrows[1])" @onclick:stopPropagation></div>
            </div>

        </div>
    </div>

    @if (currentMatch != null && string.IsNullOrWhiteSpace(error))
    {

        <ScoreBoard AllPosibleThrow="allPosibleThrow"
                    PosibleBullThrows="posibleBullThrows"
                    CurrentMatch="currentMatch"
                    CurrentScore="currentScore"></ScoreBoard>
    }
}


@code {
    private DartsMatchModel currentMatch;
    private List<ScoresPerNumberModel> allPosibleThrow;
    private List<ScoreModel> posibleBullThrows;
    private ScoreModel currentScore;
    private string error = "";
    private bool isBussy;

    private void RedirectToAddPlayer()
    {
        navigation.NavigateTo("/AddPlayer");
    }

    protected async override Task OnInitializedAsync()
    {
        isBussy = true;
        var result = await _throwService.GetAll();
        if (result.IsSucces)
        {
            var groupedPoints = result.Items.GroupBy(p => p.OriginalScore)
                        .Select(group => group.ToList())
                        .ToList();

            var bull = groupedPoints[groupedPoints.Count - 1];
            posibleBullThrows = bull.Select(p => new ScoreModel
            {
                Id = p.Id,
                Score = (int)p.Score,
                BaseScore = (int)p.OriginalScore,
                Name = p.Score.ToString()
            }).ToList();

            groupedPoints.RemoveAt(groupedPoints.Count - 1);// remove bull as it is drawn difrent
            allPosibleThrow = CreateScorePerNumberModels(groupedPoints);
            isBussy = false;

        }

    }

    private async Task CreateCurrentMatch()
    {

        var result = await _playerService.GetAllPlayersAsync();
        int maxPlayerCount;
        Random random = new Random();
        currentMatch = new DartsMatchModel {Id = Guid.NewGuid(), IsActiveMatch = true };

        List<DartsPlayerModel> valibleCandidated = new();

        if (result.IsSucces)
        {
            maxPlayerCount = result.Items.Count();
            var players = ConvertToDartsPlayerModel(result.Items.ToList());

            currentMatch.PlayerOne = players.ElementAt(random.Next(0, maxPlayerCount));
            currentMatch.PlayerOne.IsActiveTurn = true;

            var availeblePlayersResult = await _playerService.GetApponentByPlayerId(currentMatch.PlayerOne.Id);
            if (availeblePlayersResult.IsSucces)
            {
                valibleCandidated = ConvertToDartsPlayerModel(availeblePlayersResult.Items.ToList());

                maxPlayerCount = valibleCandidated.Count();
                currentMatch.PlayerTwo = valibleCandidated[random.Next(0, maxPlayerCount)];
                error = String.Empty;
            }
            else error = availeblePlayersResult.ErrorMessage;
        };
    }

    private List<DartsPlayerModel> ConvertToDartsPlayerModel(List<Player> players)
    {
        return players.Select(p => new DartsPlayerModel
        {
            Id = p.Id,
            FirstName = p.Firstname,
            LastName = p.Lastname,
            Throws = new List<ThrowModel>()
        }).ToList();
    }

    private List<ScoresPerNumberModel> CreateScorePerNumberModels(List<List<Point>> groupedPoints)
    {
        List<ScoresPerNumberModel> allPosibleThrow = new();

        foreach (var group in groupedPoints)
        {
            var scorePerModel = new ScoresPerNumberModel
            {
                Name = group.FirstOrDefault().OriginalScore.ToString()
            };
            scorePerModel.Single = new ScoreModel
            {
                Id = group[0].Id,
                Score = (int)group[0].Score,
                BaseScore = (int)group[0].OriginalScore,
                Name = group[0].OriginalScore.ToString()
            };
            scorePerModel.Double = new ScoreModel
            {
                Id = group[1].Id,
                Score = (int)group[1].Score,
                BaseScore = (int)group[1].OriginalScore,
                Name = group[1].OriginalScore.ToString()
            };
            scorePerModel.Triple = new ScoreModel
            {
                Id = group[2].Id,
                Score = (int)group[2].Score,
                BaseScore = (int)group[2].OriginalScore,
                Name = group[2].OriginalScore.ToString()
            };
            allPosibleThrow.Add(scorePerModel);

        };

        return allPosibleThrow;
    }

    private async Task AddScore(ScoreModel score)
    {
        if (currentMatch != null)
        {
            var currentPlayer = currentMatch.PlayerOne.IsActiveTurn == true ? currentMatch.PlayerOne : currentMatch.PlayerTwo;

            var newThrow = new ThrowModel { BaseNumber = score.BaseScore, Throw = score.Score, TimeStamp = DateTime.Now };
            currentPlayer.Throws.Add(newThrow);

            //var createResult = await _playerThrowService.CreateAsync(currentMatch.Id, currentPlayer.Id, score.Id);
            //if (createResult.IsSucces)
            //{
            //    var getResult = await _playerThrowService.GetByUserAndMatchIdAsync(currentMatch.Id, currentPlayer.Id);
            //    if (getResult.IsSucces) currentPlayer.Throws = getResult.Items.Select(t => new ThrowModel
            //    {
            //        BaseNumber = (int)t.Score.OriginalScore,
            //        Throw = (int)t.Score.Score,
            //        TimeStamp = t.TimeStamp
            //    }).ToList();
            //}

            var currentHits = currentPlayer.Throws.Where(t => t.BaseNumber == score.BaseScore).Count();
            currentScore = score;
            StateHasChanged();

        }
        else error = "Please create a match!";

    }



}








